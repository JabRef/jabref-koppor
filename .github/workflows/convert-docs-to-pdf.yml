name: Convert DevDocs to PDF

on:
  push:
    branches:
      - main
    paths:
      - 'docs/**.md'
      - .github/workflows/convert-docs-to-pdf.yml
  pull_request:
    paths:
      - 'docs/**.md'
      - .github/workflows/convert-docs-to-pdf.yml

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - uses: actions/setup-node@v4
      with:
        node-version: '22'

    - uses: awalsh128/cache-apt-pkgs-action@latest
      with:
        packages: poppler-utils xmlstarlet
        version: 1.0

    - run: npm install puppeteer

    - name: Crawl URLs from sitemap
      run: |
        mkdir urls
        curl -s https://devdocs.jabref.org/sitemap.xml |
            xmlstarlet sel -t -m '//url/loc' -v . -n > urls/list.txt
        sed -i 's|^/|https://devdocs.jabref.org/|' urls/list.txt
        cat urls/list.txt

    - name: Download pages as PDFs
      run: |
        mkdir pdfs
        node <<'EOF'
        const fs = require('fs');
        const puppeteer = require('puppeteer');
        (async () => {
            const urls = fs.readFileSync('urls/list.txt', 'utf-8')
                            .split('\n')
                            .filter(Boolean);
            const browser = await puppeteer.launch({
            headless: "new",
            args: ["--no-sandbox", "--disable-setuid-sandbox"]
            });
            const page = await browser.newPage();
            for (let i = 0; i < urls.length; i++) {
            const url = urls[i];
            const filename = `pdfs/page${String(i + 1).padStart(3, '0')}.pdf`;
            console.log(`Rendering ${url} â†’ ${filename}`);
            await page.goto(url, { waitUntil: 'networkidle2' });
            await page.pdf({
                path: filename,
                format: 'A4',
                printBackground: true
            });
            }
            await browser.close();
        })();
        EOF

    - name: Merge PDFs into one file
      run: |
        pdfunite pdfs/*.pdf pdfs/jabref-docs-complete.pdf

    - uses: actions/upload-artifact@v4
      with:
        name: docs
        path: pdfs/

    - name: Publish
      if: github.head_ref == 'main'
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./pdfs
        publish_branch: devdocs
        force_orphan: true
        enable_jekyll: false
